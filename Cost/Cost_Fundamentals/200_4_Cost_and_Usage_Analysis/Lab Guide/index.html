<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../img/favicon.ico">
        <title>Level 200: Cost and Usage Analysis - My Docs</title>
        <link href="../../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../../..">My Docs</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../../../..">Welcome to MkDocs</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cost <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../">AWS Well-Architected Cost Optimization Labs</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Cost Fundamentals</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">100 1 AWS Account Setup</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../100_1_AWS_Account_Setup/">Level 100: AWS Account Setup</a>
</li>
            
<li >
    <a href="../../100_1_AWS_Account_Setup/Checklist/">Level 100: AWS Account Setup: Best Practice Checklist</a>
</li>
            
<li >
    <a href="../../100_1_AWS_Account_Setup/Lab Guide/">Level 100: AWS Account Setup: Lab Guide</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">100 2 Cost and Usage Governance</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../100_2_Cost_and_Usage_Governance/">Level 100: Cost and Usage Governance</a>
</li>
            
<li >
    <a href="../../100_2_Cost_and_Usage_Governance/Checklist/">Level 100: Cost and Usage Governance</a>
</li>
            
<li >
    <a href="../../100_2_Cost_and_Usage_Governance/Lab Guide/">Level 100: Cost and Usage Governance</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">100 4 Cost and Usage Analysis</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../100_4_Cost_and_Usage_Analysis/">Level 100: Cost and Usage Analysis</a>
</li>
            
<li >
    <a href="../../100_4_Cost_and_Usage_Analysis/Checklist/">Level 100: Cost and Usage Analysis</a>
</li>
            
<li >
    <a href="../../100_4_Cost_and_Usage_Analysis/Lab Guide/">Level 100: Cost and Usage Analysis</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">100 5 Cost Visualization</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../100_5_Cost_Visualization/">Level 100: Billing Visualization</a>
</li>
            
<li >
    <a href="../../100_5_Cost_Visualization/Checklist/">Level 100: Cost Visualization</a>
</li>
            
<li >
    <a href="../../100_5_Cost_Visualization/Lab Guide/">Level 100: Cost Visualization</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">200 2 Cost and Usage Governance</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../200_2_Cost_and_Usage_Governance/">Level 200: Cost and Usage Governance</a>
</li>
            
<li >
    <a href="../../200_2_Cost_and_Usage_Governance/Checklist/">Level 200: Cost and Usage Governance</a>
</li>
            
<li >
    <a href="../../200_2_Cost_and_Usage_Governance/Lab Guide/">Level 200: Cost and Usage Governance</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">200 3 Pricing Models</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../200_3_Pricing_Models/">Level 200: Pricing Models</a>
</li>
            
<li >
    <a href="../../200_3_Pricing_Models/Checklist/">Level 200: Pricing Models Checklist</a>
</li>
            
<li >
    <a href="../../200_3_Pricing_Models/Lab Guide/">Level 200: Pricing Models</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">200 4 Cost and Usage Analysis</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../">Level 200: Cost and Usage Analysis</a>
</li>
            
<li >
    <a href="../Checklist/">Level 200: Cost and Usage Analysis</a>
</li>
            
<li class="active">
    <a href="./">Level 200: Cost and Usage Analysis</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">200 5 Cost Visualization</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../200_5_Cost_Visualization/">Level 200: Cost Visualization</a>
</li>
            
<li >
    <a href="../../200_5_Cost_Visualization/Checklist/">Level 200: Cost Visualization</a>
</li>
            
<li >
    <a href="../../200_5_Cost_Visualization/Lab Guide/">Level 200: Cost Visualization</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Cost and Usage Analysis</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../Cost_and_Usage_Analysis/">AWS Well-Architected Cost Optimization Labs</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">300 Automated CUR Updates and Ingestion</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../Cost_and_Usage_Analysis/300_Automated_CUR_Updates_and_Ingestion/">Level 300: Automated CUR Updates and Ingestion</a>
</li>
            
<li >
    <a href="../../../Cost_and_Usage_Analysis/300_Automated_CUR_Updates_and_Ingestion/Checklist/">Level 300: Automated CUR Updates and Ingestion</a>
</li>
            
<li >
    <a href="../../../Cost_and_Usage_Analysis/300_Automated_CUR_Updates_and_Ingestion/Lab Guide/">Level 300: Automated CUR Updates and Ingestion</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reliability <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../../Reliability/">AWS Well-Architected Reliability Labs</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">300   Testing for Resiliency of EC2, RDS, and S3</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../Reliability/300 - Testing for Resiliency of EC2, RDS, and S3/">Level 300: Testing for Resiliency of EC2, RDS, and S3</a>
</li>
            
<li >
    <a href="../../../../Reliability/300 - Testing for Resiliency of EC2, RDS, and S3/Builders Guide/">Builders Guide for 300 - Testing for Resiliency of EC2, RDS, and S3</a>
</li>
            
<li >
    <a href="../../../../Reliability/300 - Testing for Resiliency of EC2, RDS, and S3/Lab Guide/">Level 300: Performing Resiliency Testing for EC2, RDS, and S3</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Security <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../../Security/">AWS Well-Architected Security Labs</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">100   AWS Account & Root User</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../Security/100 - AWS Account & Root User/">Level 100: AWS Account & Root User</a>
</li>
            
<li >
    <a href="../../../../Security/100 - AWS Account & Root User/Checklist/">Level 100: AWS Account & Root User: Best Practice Checklist</a>
</li>
            
<li >
    <a href="../../../../Security/100 - AWS Account & Root User/Lab Guide/">Level 100: AWS Account & Root User: Lab Guide</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">100   Basic Identity & Access Management User, Group, Role</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../Security/100 - Basic Identity & Access Management User, Group, Role/">Level 100: Basic Identity & Access Management User, Group, Role</a>
</li>
            
<li >
    <a href="../../../../Security/100 - Basic Identity & Access Management User, Group, Role/Checklist/">Level 100: Basic Identity & Access Management User, Group, Role: Best Practice Checklist</a>
</li>
            
<li >
    <a href="../../../../Security/100 - Basic Identity & Access Management User, Group, Role/Lab Guide/">Level 100: Basic Identity & Access Management User, Group, Role: Lab Guide</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">100   CloudFront with S3 Bucket Origin</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../Security/100 - CloudFront with S3 Bucket Origin/">Level 100: CloudFront with S3 Bucket Origin</a>
</li>
            
<li >
    <a href="../../../../Security/100 - CloudFront with S3 Bucket Origin/Lab Guide/">Level 100: CloudFront with S3 Bucket Origin: Lab Guide</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">200   Automated Deployment of Detective Controls</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../Security/200 - Automated Deployment of Detective Controls/">Level 200: Automated Deployment of Detective Controls</a>
</li>
            
<li >
    <a href="../../../../Security/200 - Automated Deployment of Detective Controls/Lab Guide/">Level 200: Automated Deployment of Detective Controls: Lab Guide</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">200   Automated Deployment of EC2 Web Application</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../Security/200 - Automated Deployment of EC2 Web Application/">Level 200: Automated Deployment of EC2 Web Application</a>
</li>
            
<li >
    <a href="../../../../Security/200 - Automated Deployment of EC2 Web Application/Lab Guide/">Level 200: Automated Deployment of EC2 Web Application</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">200   Automated Deployment of IAM Groups and Roles</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../Security/200 - Automated Deployment of IAM Groups and Roles/">Level 200: Automated Deployment of IAM Groups and Roles</a>
</li>
            
<li >
    <a href="../../../../Security/200 - Automated Deployment of IAM Groups and Roles/Lab Guide/">Level 200: Automated Deployment of IAM Groups and Roles: Lab Guide</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">200   Automated Deployment of VPC</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../Security/200 - Automated Deployment of VPC/">Level 200: Automated Deployment of VPC</a>
</li>
            
<li >
    <a href="../../../../Security/200 - Automated Deployment of VPC/Lab Guide/">Level 200: Automated Deployment of VPC</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">200   Basic EC2 with WAF Protection</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../Security/200 - Basic EC2 with WAF Protection/">Level 200: EC2 Web Infrastructure Protection</a>
</li>
            
<li >
    <a href="../../../../Security/200 - Basic EC2 with WAF Protection/Checklist/">Level 100: EC2 Web Infrastructure Protection: Best Practice Checklist</a>
</li>
            
<li >
    <a href="../../../../Security/200 - Basic EC2 with WAF Protection/Lab Guide/">Level 200: EC2 Web Infrastructure Protection: Lab Guide</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">200   CloudFront with WAF Protection</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../Security/200 - CloudFront with WAF Protection/">Level 200: CloudFront with WAF Protection</a>
</li>
            
<li >
    <a href="../../../../Security/200 - CloudFront with WAF Protection/Lab Guide/">Level 100: CloudFront with WAF Protection: Lab Guide</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">300   IAM Permission Boundaries Delegating Role Creation</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../Security/300 - IAM Permission Boundaries Delegating Role Creation/">Level 300: IAM Permission Boundaries Delegating Role Creation</a>
</li>
            
<li >
    <a href="../../../../Security/300 - IAM Permission Boundaries Delegating Role Creation/Lab Guide/">Level 300: IAM Permission Boundaries Delegating Role Creation</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">300   IAM Tag Based Access Control for EC2</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../Security/300 - IAM Tag Based Access Control for EC2/">Level 300: IAM Tag Based Access Control for EC2</a>
</li>
            
<li >
    <a href="../../../../Security/300 - IAM Tag Based Access Control for EC2/Lab Guide/">Level 300: IAM Tag Based Access Control for EC2</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../Checklist/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../../200_5_Cost_Visualization/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#level-200-cost-and-usage-analysis">Level 200: Cost and Usage Analysis</a></li>
            <li><a href="#authors">Authors</a></li>
            <li><a href="#feedback">Feedback</a></li>
        <li class="main "><a href="#table-of-contents">Table of Contents</a></li>
            <li><a href="#1-verify-your-cur-files-are-being-delivered">1. Verify your CUR files are being delivered </a></li>
            <li><a href="#2-setup-amazon-athena-and-load-the-cur-files">2. Setup Amazon Athena and load the CUR files </a></li>
            <li><a href="#3-cost-and-usage-analysis">3. Cost and Usage analysis </a></li>
            <li><a href="#4-tear-down">4. Tear down </a></li>
            <li><a href="#5-survey">5. Survey </a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="level-200-cost-and-usage-analysis">Level 200: Cost and Usage Analysis</h1>
<h2 id="authors">Authors</h2>
<ul>
<li>Nathan Besh, Cost Lead, Well-Architected</li>
<li>Spencer Marley, Commercial Architect</li>
</ul>
<h2 id="feedback">Feedback</h2>
<p>If you wish to provide feedback on this lab, there is an error, or you want to make a suggestion, please email: costoptimization@amazon.com</p>
<h1 id="table-of-contents">Table of Contents</h1>
<ol>
<li><a href="#Verify_CUR">Verify your CUR files are being delivered</a></li>
<li><a href="#Setup_Athena">Setup Amazon Athena and load the CUR files</a></li>
<li><a href="#CUR_Analysis">Cost and Usage analysis</a></li>
<li><a href="#tear_down">Tear down</a></li>
<li><a href="#survey">Feedback survey</a></li>
</ol>
<h2 id="1-verify-your-cur-files-are-being-delivered">1. Verify your CUR files are being delivered <a name="Verify_CUR"></a></h2>
<p>We will verify the CUR files are being delivered, they are in the correct format and the region they are in.</p>
<ol>
<li>
<p>Log into the console as an IAM user with the required permissions, go to the <strong>Billing</strong> console, and view the CUR report you created in <a href="../100_1_AWS_Account_Setup/Lab%20Guide.md">AWS Account Setup</a>, confirm the <strong>S3 bucket</strong>, and <strong>Report path prefix</strong>:
<img alt="Images/AWSBillingAnalysis_0.png" src="../Images/AWSBillingAnalysis_0.png" /></p>
</li>
<li>
<p>Go to the <strong>S3</strong> Service console: 
<img alt="Images/AWSBillingAnalysis_1.png" src="../Images/AWSBillingAnalysis_1.png" /></p>
</li>
<li>
<p>Verify the region where the bucket is located (here it is <strong>US East N.Virginia</strong>), and click on the <strong>bucket name</strong> where the report is delivered(it is blacked out here):
<img alt="Images/AWSBillingAnalysis_2.png" src="../Images/AWSBillingAnalysis_2.png" /></p>
</li>
<li>
<p>You should see a <strong>aws-programmatic-access-test-object</strong> which was put there to verify AWS can deliver reports, and also the folder which is the report prefix - <strong>cur</strong>. Click on the folder name for the <strong>prefix</strong> (here it is cur):
<img alt="Images/AWSBillingAnalysis_3.png" src="../Images/AWSBillingAnalysis_3.png" /></p>
</li>
<li>
<p>Click on the <strong>folder name</strong> which is also part of the prefix (here it is WorkshopCUR):
<img alt="Images/AWSBillingAnalysis_4.png" src="../Images/AWSBillingAnalysis_4.png" /></p>
</li>
<li>
<p>You should see a folder for each month, which contains the <strong>sql</strong> and <strong>manifest</strong> files. You will also have a folder from the prefix, labelled <strong>WorkshopCUR</strong> here. Click on the folder for the current month, for December 2018 it will be: <strong>20181201-20190101</strong>
<img alt="Images/AWSBillingAnalysis_5.png" src="../Images/AWSBillingAnalysis_21.png" /></p>
</li>
<li>
<p>You will see the <strong>create-table.sql</strong> file, open this text file &amp; copy it to a text editor for later. This is delivered as you chose Athena support for your CUR. 
<img alt="Images/AWSBillingAnalysis_6.png" src="../Images/AWSBillingAnalysis_6.png" /></p>
</li>
<li>
<p>Here is a sample of the SQL file:
<img alt="Images/AWSBillingAnalysis_8.png" src="../Images/AWSBillingAnalysis_8.png" /></p>
</li>
<li>
<p>Go back up a level in the S3 console, and click on the <strong>prefix</strong> folder, here it is WorkshopCUR, then drill down in the current year and month:
<img alt="Images/AWSBillingAnalysis_5.png" src="../Images/AWSBillingAnalysis_5.png" /></p>
</li>
<li>
<p>You can see the delivered CUR file, it is in the <strong>parquet</strong> format:
<img alt="Images/AWSBillingAnalysis_7.png" src="../Images/AWSBillingAnalysis_7.png" /></p>
</li>
</ol>
<p>You have successfully verified that the CUR files are being delivered and in the correct format.  You have also verified that Athena support was enabled through the delivery of the sql file.</p>
<p><strong>Sample Files</strong>
You may not have substantial or interesting usage, in this case there are sample files that you can use in the code section. You will need to create the required structure in S3, download these files and then upload them into s3.</p>
<p><strong>NOTE</strong>: Do not save the links below, open them in a new window and download the files. They should be approximately 1Mb in size each, if you have files that are 65kb - then you have downloaded the web page and not the parquet files.</p>
<p>Create a folder structure, such as -bucket name-/cur/WorkshopCUR/WorkshopCUR/year=2018/month=12 and copy the parquet files below into each months folder. You will need to edit the SQL file with the correct name.
- <a href="../Code/WorkshopCUR-create-table.sql">Workshop.sql</a>
- <a href="../Code/Oct2018-WorkshopCUR-00001.snappy.parquet">October 2018 Usage</a>
- <a href="../Code/Nov2018-WorkshopCUR-00001.snappy.parquet">November 2018 Usage</a>
- <a href="../Code/Dec2018-WorkshopCUR-00001.snappy.parquet">December 2018 Usage</a></p>
<h2 id="2-setup-amazon-athena-and-load-the-cur-files">2. Setup Amazon Athena and load the CUR files <a name="Setup_Athena"></a></h2>
<p>We will configure Athena to access and view our CUR files via SQL. Athena is a serverless solution to be able to execute SQL queries across very large amounts of data. Athena is only charged for data that is scanned, and there are no ongoing costs if data is not being queried, unlike a traditional database solution.</p>
<ol>
<li>
<p>Go to the <strong>Athena</strong> console: 
<img alt="Images/AWSBillingAnalysis_9.png" src="../Images/AWSBillingAnalysis_9.png" /></p>
</li>
<li>
<p>If prompted, click on <strong>Get Started</strong>:
<img alt="Images/AWSBillingAnalysis_10.png" src="../Images/AWSBillingAnalysis_10.png" /></p>
</li>
<li>
<p>Go to your text editor, view the first line in the SQL file and check the name of the database, here it is <strong>WorkshopCUR</strong> 
<img alt="Images/AWSBillingAnalysis_20.png" src="../Images/AWSBillingAnalysis_20.png" /></p>
</li>
<li>
<p>In the Athena console, check the region in the top right is the same as the S3 bucket (here it is <strong>N.Virginia</strong>), then create the database in Athena - with the exact name above (check the case matches), by pasting the following code into the query window, and click on <strong>Run query</strong>:</p>
</li>
</ol>
<pre><code>CREATE DATABASE IF NOT EXISTS WorkshopCUR
  COMMENT 'Database for CUR files';
</code></pre>

<p><img alt="Images/AWSBillingAnalysis_11.png" src="../Images/AWSBillingAnalysis_11.png" /></p>
<ol>
<li>
<p>You will see in the lower <strong>Results</strong> window <strong>Query successful</strong>, and on the left - a new <strong>workshopcur</strong> database has been created:
<img alt="Images/AWSBillingAnalysis_12.png" src="../Images/AWSBillingAnalysis_12.png" /></p>
</li>
<li>
<p>Select the <strong>workshopcur</strong> database on the left, copy and paste the entire <strong>.sql</strong> file you have in your text editor into the query window, and click <strong>Run query</strong>:
<img alt="Images/AWSBillingAnalysis_13.png" src="../Images/AWSBillingAnalysis_13.png" /></p>
</li>
<li>
<p>A new table called <strong>workshop_c_u_r</strong> will have been created, we will now load the partitions. Click on the <strong>3 dot menu</strong> and select <strong>Load partitions</strong>:
<img alt="Images/AWSBillingAnalysis_14.png" src="../Images/AWSBillingAnalysis_14.png" /></p>
</li>
<li>
<p>You will see it execute the command <strong>MSCK REPAIR TABLE</strong>, and in the results it will add partitions to the metastore for each month that has a billing file:
<img alt="Images/AWSBillingAnalysis_15.png" src="../Images/AWSBillingAnalysis_15.png" />
NOTE: If it did not add partitions, then there is an error and there will be no data. 
Check</p>
</li>
<li>The database name is correct &amp; the same as the SQL file</li>
<li>The folder names <strong>year</strong> and <strong>month</strong> are in S3 and the case matches</li>
<li>
<p>There are parquet files in each of the month folders</p>
</li>
<li>
<p>We will now preview the data.  Click on the <strong>3 dot menu</strong> and select <strong>Preview table</strong>:
<img alt="Images/AWSBillingAnalysis_16.png" src="../Images/AWSBillingAnalysis_16.png" /></p>
</li>
<li>
<p>It will execute a <strong>Select * from</strong> query, and in the results you will see the first 10 lines of your CUR file:
<img alt="Images/AWSBillingAnalysis_17.png" src="../Images/AWSBillingAnalysis_17.png" /></p>
</li>
<li>
<p>(Optional if you have a linked account) We will create a member account table, this is for large organizations or partners - that want only a single accounts usage to be visible to them.
Copy and paste the following code:</p>
</li>
</ol>
<pre><code>CREATE TABLE linked_AccountID
WITH (
      format = 'Parquet',
      parquet_compression = 'SNAPPY')
AS SELECT * FROM &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where &quot;line_item_usage_account_id&quot; = 'AccountID'
</code></pre>

<p>NOTE: replace <strong>AccountID</strong> with the 12 digit account ID of your member account.</p>
<p>You will see a new table created on the left:
<img alt="Images/AWSBillingAnalysis_18.png" src="../Images/AWSBillingAnalysis_18.png" />
NOTE: You can restrict and grant access to this specific member account table through IAM policies. This will be covered in the 300 level billing analysis lab </p>
<p>You have successfully setup your CUR file to be analyzed. You can now query your usage and costs via SQL.</p>
<h2 id="3-cost-and-usage-analysis">3. Cost and Usage analysis <a name="CUR_Analysis"></a></h2>
<p>We will now perform some common analysis of your usage through SQL queries. You will be charged for Athena usage by the amount of data that is scanned - the source files are monthly, and in parquet format - which is compressed and partitioned to minimise cost. Be careful to include <strong>limit 10</strong> or similar at the end of your queries to limit the amount of data that comes back.</p>
<p>For each of the queries below, copy and paste each query into the query window, click <strong>Run query</strong> and view the results.
<img alt="Images/AWSBillingAnalysis_19.png" src="../Images/AWSBillingAnalysis_19.png" /></p>
<p>We will restrict the queries to a single month (December, 2018) by including the following line:</p>
<pre><code>where month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
</code></pre>

<h3 id="31-what-data-is-available-in-the-cur-file">3.1 What data is available in the CUR file?</h3>
<p>We will learn how to find out what data is available for querying in the CUR files, this will show what columns there are and some sample data in those columns.</p>
<ol>
<li>What columns and data are in the CUR table?</li>
</ol>
<pre><code>select * from &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot; 
where month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
limit 10;
</code></pre>

<ol>
<li>What are all the different values in a column? (the column we use is <strong>line_item_line_item_description</strong>)</li>
</ol>
<pre><code>select distinct &quot;line_item_line_item_description&quot; from &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
limit 10;
</code></pre>

<p>3 Give me all columns from the CUR, where a specific value is in a column (here the column <strong>line_item_line_item_type</strong> contains the word <strong>Usage</strong> somewhere, note the capital 'U'):</p>
<pre><code>select * from &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where &quot;line_item_line_item_type&quot; like '%Usage%' and month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
limit 10;
</code></pre>

<ol>
<li>What billing periods are available?</li>
</ol>
<pre><code>SELECT distinct bill_billing_period_start_date FROM &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
limit 10;
</code></pre>

<h3 id="32-top-costs">3.2 Top Costs</h3>
<p>To efficiently optimize its useful to view the top costs in different categories, such as service, description or tags.</p>
<ol>
<li>Top10 Costs by AccountID:</li>
</ol>
<pre><code>select &quot;line_item_usage_account_id&quot;, round(sum(&quot;line_item_unblended_cost&quot;),2) as cost from &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
group by &quot;line_item_usage_account_id&quot;
order by cost desc
limit 10;
</code></pre>

<ol>
<li>Top10 Costs by Product:</li>
</ol>
<pre><code>select &quot;line_item_product_code&quot;, round(sum(&quot;line_item_unblended_cost&quot;),2) as cost from &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
group by &quot;line_item_product_code&quot;
order by cost desc
limit 10;
</code></pre>

<ol>
<li>Top Costs by Line Item Description</li>
</ol>
<pre><code>select &quot;line_item_product_code&quot;, &quot;line_item_line_item_description&quot;, round(sum(&quot;line_item_unblended_cost&quot;),2) as cost from &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
group by &quot;line_item_product_code&quot;, &quot;line_item_line_item_description&quot;
order by cost desc
limit 10;
</code></pre>

<ol>
<li>Top EC2 Costs</li>
</ol>
<pre><code>select &quot;line_item_product_code&quot;, &quot;line_item_line_item_description&quot;, round(sum(&quot;line_item_unblended_cost&quot;),2) as cost from &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where &quot;line_item_product_code&quot; like '%AmazonEC2%' and month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
group by &quot;line_item_product_code&quot;, &quot;line_item_line_item_description&quot;
order by cost desc
limit 10;
</code></pre>

<ol>
<li>Top EC2 OnDemand Costs</li>
</ol>
<pre><code>select &quot;line_item_product_code&quot;, &quot;line_item_line_item_description&quot;, round(sum(&quot;line_item_unblended_cost&quot;),2) as cost from &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where &quot;line_item_product_code&quot; like '%AmazonEC2%' and &quot;line_item_usage_type&quot; like '%BoxUsage%' and  month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
group by &quot;line_item_product_code&quot;, &quot;line_item_line_item_description&quot;
order by cost desc
limit 10;
</code></pre>

<h3 id="33-tagging-and-chargeback">3.3 Tagging and Chargeback</h3>
<p>Common in large organizations is the requirement to allocate costs back to specific business units. It is also critical for optimization to be able to allocate costs to workloads, to measure workload efficiency.
<strong>NOTE</strong>: This will only work if you have tags enabled in your billng files, and they are the same as the examples here - <strong>resource_tags_user_cost_center</strong></p>
<ol>
<li>Top 20 Costs by line item description and CostCenter Tag</li>
</ol>
<pre><code>SELECT &quot;bill_payer_account_id&quot;, &quot;product_product_name&quot;, &quot;line_item_usage_type&quot;, &quot;line_item_line_item_description&quot;, resource_tags_user_cost_center, round(sum(line_item_unblended_cost),2) as cost FROM &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where length(&quot;resource_tags_user_cost_center&quot;) &gt;0 and month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
group by &quot;resource_tags_user_cost_center&quot;, &quot;bill_payer_account_id&quot;, &quot;product_product_name&quot;, &quot;line_item_usage_type&quot;, &quot;line_item_line_item_description&quot;
order by cost desc
limit 20
</code></pre>

<ol>
<li>Top 20 costs by line item description, without a CostCenter Tag</li>
</ol>
<pre><code>SELECT &quot;bill_payer_account_id&quot;, &quot;product_product_name&quot;, &quot;line_item_usage_type&quot;, &quot;line_item_line_item_description&quot;, round(sum(line_item_unblended_cost),2) as cost FROM &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where length(&quot;resource_tags_user_cost_center&quot;) = 0 and month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
group by &quot;bill_payer_account_id&quot;, &quot;product_product_name&quot;, &quot;line_item_usage_type&quot;, &quot;line_item_line_item_description&quot;
order by cost desc
limit 20
</code></pre>

<h3 id="34-reserved-instance-on-demand-and-spot-usage">3.4 Reserved Instance, On Demand and Spot Usage</h3>
<p>To improve the use of pricing models across a business, these queries can assist to highlight the top opportunities for Reserved Instance (top On Demand cost), and also identify who is successful with pricing models (Top users of spot).
<strong>NOTE</strong>: You will need specific usage in your account that matches the instance types below, for this to work correctly.</p>
<ol>
<li>Who used Reserved Instances
Identify which accounts used the available RIs, and what they would have paid with public pricing. Ideal for chargeback within an organization.</li>
</ol>
<pre><code>select &quot;bill_payer_account_id&quot;, &quot;bill_billing_period_start_date&quot;, &quot;line_item_usage_account_id&quot;, &quot;reservation_reservation_a_r_n&quot;, &quot;line_item_product_code&quot;, &quot;line_item_usage_type&quot;, sum(&quot;line_item_usage_amount&quot;) as Usage, &quot;line_item_unblended_rate&quot;, sum(&quot;line_item_unblended_cost&quot;) as Cost, &quot;line_item_line_item_description&quot;, &quot;pricing_public_on_demand_rate&quot;, sum(&quot;pricing_public_on_demand_cost&quot;) as PublicCost from &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where &quot;line_item_line_item_Type&quot; like '%DiscountedUsage%' 
group by &quot;bill_payer_account_id&quot;, &quot;bill_billing_period_start_date&quot;, &quot;line_item_usage_account_id&quot;, &quot;reservation_reservation_a_r_n&quot;, &quot;line_item_product_code&quot;, &quot;line_item_usage_type&quot;, &quot;line_item_unblended_rate&quot;, &quot;line_item_line_item_description&quot;, &quot;pricing_public_on_demand_rate&quot;
</code></pre>

<ol>
<li>T2 family instance usage
Observe how much is being spent on each different family (usage type) and how much is covered by Reserved instances.</li>
</ol>
<pre><code>select &quot;line_item_usage_type&quot;, sum(&quot;line_item_usage_amount&quot;) as usage, round(sum(&quot;line_item_unblended_cost&quot;),2) as cost from &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where &quot;line_item_usage_type&quot; like '%t2.%' and month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
group by &quot;line_item_usage_type&quot;
order by &quot;line_item_usage_type&quot;
</code></pre>

<ol>
<li>Costs By running type
Divide the cost by usage (hrs), and see how much is being spent per hour on each of the usage types. Compare <strong>BoxUsgae</strong> (On Demand), to <strong>HeavyUsage</strong> (Reserved instance), to <strong>SpotUsage</strong> (Spot).</li>
</ol>
<pre><code>select &quot;line_item_usage_type&quot;, round(sum(&quot;line_item_usage_amount&quot;),2) as usage, round(sum(&quot;line_item_unblended_cost&quot;),2) as cost, round(avg(&quot;line_item_unblended_cost&quot;/&quot;line_item_usage_amount&quot;),4) as hourly_rate from &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where &quot;line_item_product_code&quot; like '%AmazonEC2%' and &quot;line_item_usage_type&quot; like '%Usage%' and month(bill_billing_period_start_date) = 12 and year(bill_billing_period_start_date) = 2018
group by &quot;line_item_usage_type&quot;
order by &quot;line_item_usage_type&quot;
</code></pre>

<ol>
<li>Show unused Reserved Instances
This will show how much of your reserved instances are not being used, and sorts it via cost of unused portion (recurring fee).
You can use this in two ways:</li>
<li>See where you have spare RI's and modify instances to match, so they will use the RIs</li>
<li>Convert your existing RI's if possible</li>
</ol>
<pre><code>select bill_billing_period_start_date, product_region, line_item_usage_type, reservation_reservation_a_r_n, reservation_unused_quantity, reservation_unused_recurring_fee from &quot;workshopcur&quot;.&quot;workshop_c_u_r&quot;
where length(reservation_reservation_a_r_n) &gt; 0 and reservation_unused_quantity &gt; 0
order by bill_billing_period_start_date, reservation_unused_recurring_fee desc
</code></pre>

<h2 id="4-tear-down">4. Tear down <a name="tear_down"></a></h2>
<p>Amazon Athena only charges when it is being used, i.e. data is being scanned - so if it is not being actively queried, there are no charges. It is also best practice to regularly analyze your usage and cost, so there is no teardown for this lab.</p>
<h2 id="5-survey">5. Survey <a name="survey"></a></h2>
<p>Thanks for taking the lab, We hope that you can take this short survey (&lt;2 minutes), to share your insights and help us improve our content.</p>
<p><a href="https://amazonmr.au1.qualtrics.com/jfe/form/SV_bdUZiCBDHx4M4At"><img alt="Survey" src="../Images/survey.png" /></a></p>
<p>This survey is hosted by an external company (Qualtrics) , so the link above does not lead to our website.  Please note that AWS will own the data gathered via this survey and will not share the information/results collected with survey respondents.  Your responses to this survey will be subject to Amazons Privacy Policy.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../../..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../../../../js/base.js" defer></script>
        <script src="../../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
